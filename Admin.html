<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Registro de Trámites</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">

    <!-- Login -->
    <div id="loginDiv" class="card">
      <h2>Login Admin</h2>
      <input type="email" id="email" placeholder="Correo" required />
      <input type="password" id="password" placeholder="Contraseña" required />
      <button id="loginBtn">Login</button>
      <p id="message"></p>
    </div>

    <!-- Panel Admin -->
    <div id="adminPanel" class="card" style="display:none;">
      <button id="logoutBtn" class="btn-red">Logout</button>

      <h3>Agregar Kiosco</h3>
      <input type="text" id="nuevoKiosco" placeholder="Nombre Kiosco" />
      <button id="addKioscoBtn">Agregar</button>

      <h3>Agregar Trámite</h3>
      <input type="text" id="nuevoTramite" placeholder="Nombre Trámite" />
      <button id="addTramiteBtn">Agregar</button>

      <h3>Descargar Registros</h3>
      <button id="downloadBtn">Descargar Excel</button>
    </div>

  </div>

  <!-- Scripts -->
  <script type="module">
    import { supabase } from './supabase.js';

    const loginDiv = document.getElementById("loginDiv");
    const adminPanel = document.getElementById("adminPanel");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const message = document.getElementById("message");

    // LOGIN
    loginBtn.addEventListener("click", async () => {
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();
      if (!email || !password) {
        message.textContent = "⚠️ Ingresa correo y contraseña";
        return;
      }
      try {
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) {
          message.textContent = "❌ " + error.message;
        } else {
          message.textContent = "✅ Bienvenido!";
          loginDiv.style.display = "none";
          adminPanel.style.display = "block";
        }
      } catch (err) {
        message.textContent = "⚠️ Error inesperado. Revisa la consola.";
        console.error(err);
      }
    });

    // LOGOUT
    logoutBtn.addEventListener("click", async () => {
      await supabase.auth.signOut();
      loginDiv.style.display = "block";
      adminPanel.style.display = "none";
      message.textContent = "";
    });

    // Agregar Kiosco
    document.getElementById("addKioscoBtn").addEventListener("click", async () => {
      const nombre = document.getElementById("nuevoKiosco").value.trim();
      if (!nombre) return alert("Ingresa un nombre de kiosco");
      const { data, error } = await supabase.from("kioscos").insert([{ nombre }]);
      if (error) alert("Error: " + error.message);
      else alert("Kiosco agregado");
    });

    // Agregar Trámite
    document.getElementById("addTramiteBtn").addEventListener("click", async () => {
      const nombre = document.getElementById("nuevoTramite").value.trim();
      if (!nombre) return alert("Ingresa un nombre de trámite");
      const { data, error } = await supabase.from("tramites").insert([{ nombre }]);
      if (error) alert("Error: " + error.message);
      else alert("Trámite agregado");
    });

    // Descargar Excel

// DESCARGAR EXCEL UTF-8
downloadBtn.addEventListener("click", async () => {
  try {
    const { data, error } = await supabase
      .from("registros_tramites")
      .select(`
        folio,
        fecha_registro,
        registros_tramites_kiosco_id_fkey(nombre),
        registros_tramites_tramite_id_fkey(nombre)
      `);

    if (error) throw error;
    if (!data.length) return alert("No hay registros para exportar.");

    // CSV con BOM UTF-8
    let csv = "\uFEFF";
    csv += "Folio,Fecha,Kiosco,Trámite\n";

    data.forEach(row => {
      const fecha = new Date(row.fecha_registro);
      const fechaFormateada = `${fecha.getDate().toString().padStart(2,'0')}/${(fecha.getMonth()+1).toString().padStart(2,'0')}/${fecha.getFullYear()}`;
      csv += `"${row.folio}","${fechaFormateada}","${row.registros_tramites_kiosco_id_fkey.nombre}","${row.registros_tramites_tramite_id_fkey.nombre}"\n`;
    });

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "registros_tramites.csv";
    a.click();
    URL.revokeObjectURL(url);

  } catch (err) {
    console.error("Error al obtener registros:", err);
    alert("Error al obtener registros: " + err.message);
  }
    });
  </script>
</body>
</html>
